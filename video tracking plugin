<?php
/*
Plugin Name: Bulk Video Tracker
Description: Bulk upload YouTube/Facebook/Instagram videos, show thumbnails with play button, redirect users, and track clicks and returns.
Version: 1.0
Author: Bhagwan Singh
*/

if (!defined('ABSPATH')) exit;

/* =========================================
 * REGISTER CUSTOM POST TYPE
 * ========================================= */
add_action('init', function () {
    register_post_type('video_link', [
        'labels' => [
            'name' => 'Video Links',
            'singular_name' => 'Video Link',
        ],
        'public' => true,
        'show_in_menu' => false, // Hide from main menu, use custom menu instead
        'menu_icon' => 'dashicons-video-alt3',
        'supports' => ['title'],
    ]);
});

/* =========================================
 * CREATE DATABASE TABLE FOR TRACKING
 * ========================================= */
register_activation_hook(__FILE__, function() {
    global $wpdb;
    $table = $wpdb->prefix.'video_clicks';
    $coins_table = $wpdb->prefix.'user_claim_coins';
    $charset = $wpdb->get_charset_collate();

    // Create video clicks table
    $sql = "CREATE TABLE IF NOT EXISTS $table (
        id BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        user_id BIGINT(20) DEFAULT NULL,
        video_id BIGINT(20) DEFAULT NULL,
        video_url TEXT NOT NULL,
        redirect_time DATETIME DEFAULT NULL,
        return_time DATETIME DEFAULT NULL,
        ip_address VARCHAR(100) DEFAULT NULL,
        coins_eligible TINYINT(1) DEFAULT 0,
        coins_claimed TINYINT(1) DEFAULT 0,
        PRIMARY KEY (id)
    ) $charset;";

    // Create user claim coins table (also stores deductions with negative amounts)
    $sql2 = "CREATE TABLE IF NOT EXISTS $coins_table (
        id BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT,
        user_id BIGINT(20) NOT NULL,
        click_id BIGINT(20) DEFAULT NULL,
        coins_amount INT(11) DEFAULT 1,
        claimed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        transaction_type VARCHAR(20) DEFAULT 'claim',
        video_upload_id BIGINT(20) DEFAULT NULL,
        PRIMARY KEY (id),
        KEY user_id (user_id),
        KEY click_id (click_id)
    ) $charset;";

    require_once(ABSPATH.'wp-admin/includes/upgrade.php');
    dbDelta($sql);
    dbDelta($sql2);
    
	// Add return_token column if not exists
$columns = $wpdb->get_col("DESCRIBE {$wpdb->prefix}video_clicks");
if (!in_array('return_token', $columns)) {
    $wpdb->query("ALTER TABLE {$wpdb->prefix}video_clicks ADD COLUMN return_token VARCHAR(100) DEFAULT NULL");
    $wpdb->query("ALTER TABLE {$wpdb->prefix}video_clicks ADD UNIQUE KEY return_token_unique (return_token)");
}
	
    // Add new columns to existing table if they don't exist
    $columns = $wpdb->get_col("DESCRIBE $table");
    if (!in_array('coins_eligible', $columns)) {
        $wpdb->query("ALTER TABLE $table ADD COLUMN coins_eligible TINYINT(1) DEFAULT 0");
    }
    if (!in_array('coins_claimed', $columns)) {
        $wpdb->query("ALTER TABLE $table ADD COLUMN coins_claimed TINYINT(1) DEFAULT 0");
    }
    if (!in_array('coins_eligible_at', $columns)) {
        $wpdb->query("ALTER TABLE $table ADD COLUMN coins_eligible_at DATETIME DEFAULT NULL");
    }
    
    // Add new columns to coins table if they don't exist
    $coins_columns = $wpdb->get_col("DESCRIBE $coins_table");
    if (!in_array('transaction_type', $coins_columns)) {
        $wpdb->query("ALTER TABLE $coins_table ADD COLUMN transaction_type VARCHAR(20) DEFAULT 'claim'");
    }
    if (!in_array('video_upload_id', $coins_columns)) {
        $wpdb->query("ALTER TABLE $coins_table ADD COLUMN video_upload_id BIGINT(20) DEFAULT NULL");
    }
    // Update click_id to allow NULL if it doesn't already
    $click_id_info = $wpdb->get_row("SHOW COLUMNS FROM $coins_table WHERE Field = 'click_id'");
    if ($click_id_info && $click_id_info->Null === 'NO') {
        $wpdb->query("ALTER TABLE $coins_table MODIFY COLUMN click_id BIGINT(20) DEFAULT NULL");
    }
});

/* =========================================
 * HELPER FUNCTION: GET USER COIN BALANCE
 * ========================================= */
function bvt_get_user_coins($user_id) {
    if (!$user_id) return 0;
    global $wpdb;
    $coins_table = $wpdb->prefix . 'user_claim_coins';
    $total = $wpdb->get_var($wpdb->prepare(
        "SELECT SUM(coins_amount) FROM $coins_table WHERE user_id = %d",
        $user_id
    ));
    return $total ? intval($total) : 0;
}

/* =========================================
 * HELPER FUNCTION: GET VIDEO THUMBNAIL
 * ========================================= */
function bvt_get_video_thumbnail($url, $video_id = null) {
    // Check if thumbnail is cached in post meta
    if ($video_id) {
        $cached_thumbnail = get_post_meta($video_id, '_video_thumbnail', true);
        if (!empty($cached_thumbnail)) {
            return $cached_thumbnail;
        }
    }
    
    $thumbnail = '';
    
    // Get YouTube thumbnail
    if (strpos($url, 'youtube.com') !== false || strpos($url, 'youtu.be') !== false) {
        preg_match("#(?<=v=|youtu.be/)[a-zA-Z0-9_-]+#", $url, $matches);
        if (!empty($matches[0])) {
            $thumbnail = 'https://img.youtube.com/vi/'.$matches[0].'/hqdefault.jpg';
        }
    }
    // Get Facebook video thumbnail
    elseif (strpos($url, 'facebook.com') !== false || strpos($url, 'fb.com') !== false || strpos($url, 'fb.watch') !== false) {
        // Try to extract video ID from Facebook URL
        // Facebook video URLs can be: https://www.facebook.com/watch/?v=VIDEO_ID
        // or https://www.facebook.com/USERNAME/videos/VIDEO_ID/
        // or https://fb.watch/VIDEO_ID/
        $video_id_fb = null;
        if (preg_match('#(?:v=|videos/|watch/)(\d+)#', $url, $matches)) {
            $video_id_fb = $matches[1];
        } elseif (preg_match('#fb\.watch/([a-zA-Z0-9_-]+)#', $url, $matches)) {
            $video_id_fb = $matches[1];
        }
        
        if ($video_id_fb) {
            // Use Facebook oEmbed API
            $oembed_url = 'https://www.facebook.com/plugins/video/oembed.json?url=' . urlencode($url);
            $response = wp_remote_get($oembed_url, ['timeout' => 5]);
            if (!is_wp_error($response) && wp_remote_retrieve_response_code($response) === 200) {
                $body = json_decode(wp_remote_retrieve_body($response), true);
                if (isset($body['thumbnail_url'])) {
                    $thumbnail = $body['thumbnail_url'];
                }
            }
            // Fallback: Try Graph API picture endpoint (may not work without token)
            if (!$thumbnail && is_numeric($video_id_fb)) {
                $thumbnail = 'https://graph.facebook.com/' . $video_id_fb . '/picture';
            }
        }
    }
    // Get Instagram video thumbnail
    elseif (strpos($url, 'instagram.com') !== false) {
        // Instagram URLs: https://www.instagram.com/p/POST_ID/ or https://www.instagram.com/reel/REEL_ID/
        // Use Instagram oEmbed API
        $oembed_url = 'https://api.instagram.com/oembed?url=' . urlencode($url);
        $response = wp_remote_get($oembed_url, ['timeout' => 5]);
        if (!is_wp_error($response) && wp_remote_retrieve_response_code($response) === 200) {
            $body = json_decode(wp_remote_retrieve_body($response), true);
            if (isset($body['thumbnail_url'])) {
                $thumbnail = $body['thumbnail_url'];
            }
        }
    }
    
    // Fallback placeholder if no thumbnail found
    if (!$thumbnail) {
        $thumbnail = 'https://via.placeholder.com/480x270?text=Video';
    }
    
    // Cache the thumbnail in post meta if video_id is provided
    if ($video_id && $thumbnail) {
        update_post_meta($video_id, '_video_thumbnail', $thumbnail);
    }
    
    return $thumbnail;
}

/* =========================================
 * ADMIN MENU PAGE WITH SUB-MENUS
 * ========================================= */
add_action('admin_menu', function () {
    // Main menu
    add_menu_page(
        'Bulk Video Tracker',
        'Video Tracker',
        'manage_options',
        'bulk-video-upload',
        'bvt_admin_page',
        'dashicons-video-alt2'
    );
    
    // Sub-menu: Bulk Upload (same as main page)
    add_submenu_page(
        'bulk-video-upload',
        'Bulk Upload',
        'Bulk Upload',
        'manage_options',
        'bulk-video-upload',
        'bvt_admin_page'
    );
    
    // Sub-menu: Video Management (new comprehensive page)
    add_submenu_page(
        'bulk-video-upload',
        'Video Management',
        'Video Management',
        'manage_options',
        'bvt-video-management',
        'bvt_video_management_page'
    );
    
    // Sub-menu: All Videos (keep for backward compatibility)
    add_submenu_page(
        'bulk-video-upload',
        'All Videos',
        'All Videos',
        'manage_options',
        'bvt-all-videos',
        'bvt_all_videos_page'
    );
    
    // Sub-menu: Tracking Stats
    add_submenu_page(
        'bulk-video-upload',
        'Tracking Stats',
        'Tracking Stats',
        'manage_options',
        'bvt-tracking-stats',
        'bvt_tracking_stats_page'
    );
    
    // Sub-menu: Shortcodes
    add_submenu_page(
        'bulk-video-upload',
        'Shortcodes',
        'Shortcodes',
        'manage_options',
        'bvt-shortcodes',
        'bvt_shortcodes_page'
    );
});

function bvt_admin_page() {
    // Show success message
    if (isset($_GET['success']) && $_GET['success'] == '1') {
        echo '<div class="notice notice-success is-dismissible"><p>Videos uploaded successfully!</p></div>';
    }
    if (isset($_GET['error'])) {
        $error_msg = sanitize_text_field($_GET['error']);
        echo '<div class="notice notice-error is-dismissible"><p>Error: ' . esc_html($error_msg) . '</p></div>';
    }
    ?>
    <div class="wrap">
        <h1>Bulk Video URL Upload</h1>
        <form method="post">
            <?php wp_nonce_field('bvt_upload_nonce'); ?>
            <textarea name="video_urls" rows="10" style="width:100%;" placeholder="Paste video URLs (one per line)..."></textarea>
            <p>
                <button type="submit" name="bvt_submit" class="button button-primary">Upload Videos</button>
            </p>
        </form>
    </div>
    <?php
}

/* =========================================
 * VIDEO MANAGEMENT PAGE (Comprehensive)
 * ========================================= */
function bvt_video_management_page() {
    global $wpdb;
    
    // Handle actions
    if (isset($_GET['action']) && isset($_GET['video_id'])) {
        if (!current_user_can('manage_options')) {
            wp_die('Unauthorized');
        }
        
        $video_id = intval($_GET['video_id']);
        $action = sanitize_text_field($_GET['action']);
        
        if ($action == 'delete') {
            check_admin_referer('delete_video_' . $video_id);
            wp_delete_post($video_id, true);
            echo '<div class="notice notice-success is-dismissible"><p>Video deleted successfully!</p></div>';
        } elseif ($action == 'hide') {
            check_admin_referer('hide_video_' . $video_id);
            update_post_meta($video_id, '_video_hidden', 1);
            echo '<div class="notice notice-success is-dismissible"><p>Video hidden from frontend!</p></div>';
        } elseif ($action == 'show') {
            check_admin_referer('show_video_' . $video_id);
            delete_post_meta($video_id, '_video_hidden');
            echo '<div class="notice notice-success is-dismissible"><p>Video shown on frontend!</p></div>';
        }
    }
    
    // Get filter parameters
    $filter_uploader = isset($_GET['filter_uploader']) ? sanitize_text_field($_GET['filter_uploader']) : '';
    $filter_status = isset($_GET['filter_status']) ? sanitize_text_field($_GET['filter_status']) : '';
    $search_term = isset($_GET['s']) ? sanitize_text_field($_GET['s']) : '';
    
    // Build query
    $query_args = [
        'post_type' => 'video_link',
        'posts_per_page' => -1,
        'orderby' => 'date',
        'order' => 'DESC',
    ];
    
    // Apply filters
    $meta_query = [];
    if ($filter_uploader == 'admin') {
        $meta_query[] = [
            'key' => '_uploaded_by',
            'compare' => 'NOT EXISTS'
        ];
    } elseif ($filter_uploader == 'user') {
        $meta_query[] = [
            'key' => '_uploaded_by',
            'compare' => 'EXISTS'
        ];
    }
    
    if ($filter_status == 'hidden') {
        $meta_query[] = [
            'key' => '_video_hidden',
            'value' => '1',
            'compare' => '='
        ];
    } elseif ($filter_status == 'visible') {
        $meta_query[] = [
            'key' => '_video_hidden',
            'compare' => 'NOT EXISTS'
        ];
    }
    
    if (!empty($meta_query)) {
        $query_args['meta_query'] = $meta_query;
    }
    
    if (!empty($search_term)) {
        $query_args['s'] = $search_term;
    }
    
    $query = new WP_Query($query_args);
    $table = $wpdb->prefix . 'video_clicks';
    $coins_table = $wpdb->prefix . 'user_claim_coins';
    
    ?>
    <div class="wrap">
        <h1>Video Management</h1>
        
        <!-- Filters -->
        <div class="tablenav top" style="margin: 20px 0;">
            <form method="get" style="display: inline-block;">
                <input type="hidden" name="page" value="bvt-video-management">
                
                <label for="filter_uploader" style="margin-right: 10px;">Uploader:</label>
                <select name="filter_uploader" id="filter_uploader" style="margin-right: 15px;">
                    <option value="">All</option>
                    <option value="admin" <?php selected($filter_uploader, 'admin'); ?>>Admin</option>
                    <option value="user" <?php selected($filter_uploader, 'user'); ?>>Users</option>
                </select>
                
                <label for="filter_status" style="margin-right: 10px;">Status:</label>
                <select name="filter_status" id="filter_status" style="margin-right: 15px;">
                    <option value="">All</option>
                    <option value="visible" <?php selected($filter_status, 'visible'); ?>>Visible</option>
                    <option value="hidden" <?php selected($filter_status, 'hidden'); ?>>Hidden</option>
                </select>
                
                <label for="s" style="margin-right: 10px;">Search:</label>
                <input type="text" name="s" id="s" value="<?php echo esc_attr($search_term); ?>" placeholder="Video URL..." style="margin-right: 10px;">
                
                <button type="submit" class="button">Filter</button>
                <a href="?page=bvt-video-management" class="button">Reset</a>
            </form>
        </div>
        
        <table class="wp-list-table widefat fixed striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Video URL</th>
                    <th>Uploaded By</th>
                    <th>Date Added</th>
                    <th>Total Clicks</th>
                    <th>Coins Claimed</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php if ($query->have_posts()) : ?>
                    <?php while ($query->have_posts()) : $query->the_post(); 
                        $video_id = get_the_ID();
                        $video_url = get_post_meta($video_id, '_video_url', true);
                        $uploaded_by = get_post_meta($video_id, '_uploaded_by', true);
                        $is_hidden = get_post_meta($video_id, '_video_hidden', true);
                        
                        // Get click count
                        $click_count = $wpdb->get_var($wpdb->prepare(
                            "SELECT COUNT(*) FROM $table WHERE video_id = %d",
                            $video_id
                        ));
                        
                        // Get coins claimed count for this video
                        $coins_claimed_count = $wpdb->get_var($wpdb->prepare(
                            "SELECT COUNT(*) 
                             FROM $coins_table ucc
                             INNER JOIN $table vc ON ucc.click_id = vc.id
                             WHERE vc.video_id = %d 
                             AND ucc.transaction_type = 'claim'",
                            $video_id
                        ));
                        
                        // Get uploader name
                        if ($uploaded_by) {
                            $uploader = get_userdata($uploaded_by);
                            $uploader_name = $uploader ? $uploader->display_name . ' (User ID: ' . $uploaded_by . ')' : 'User ID: ' . $uploaded_by;
                        } else {
                            $uploader_name = 'Admin';
                        }
                    ?>
                        <tr>
                            <td><?php echo $video_id; ?></td>
                            <td><a href="<?php echo esc_url($video_url); ?>" target="_blank"><?php echo esc_html($video_url); ?></a></td>
                            <td><?php echo esc_html($uploader_name); ?></td>
                            <td><?php echo get_the_date('Y-m-d H:i:s'); ?></td>
                            <td><strong><?php echo intval($click_count); ?></strong></td>
                            <td><strong style="color: #ff6b00;"><?php echo intval($coins_claimed_count); ?></strong></td>
                            <td>
                                <?php if ($is_hidden) : ?>
                                    <span style="color: red; font-weight: bold;">Hidden</span>
                                <?php else : ?>
                                    <span style="color: green; font-weight: bold;">Visible</span>
                                <?php endif; ?>
                            </td>
                            <td>
                                <?php if ($is_hidden) : ?>
                                    <a href="<?php echo wp_nonce_url(admin_url('admin.php?page=bvt-video-management&action=show&video_id=' . $video_id), 'show_video_' . $video_id); ?>" 
                                       class="button button-small">Show</a>
                                <?php else : ?>
                                    <a href="<?php echo wp_nonce_url(admin_url('admin.php?page=bvt-video-management&action=hide&video_id=' . $video_id), 'hide_video_' . $video_id); ?>" 
                                       class="button button-small">Hide</a>
                                <?php endif; ?>
                                <a href="<?php echo wp_nonce_url(admin_url('admin.php?page=bvt-video-management&action=delete&video_id=' . $video_id), 'delete_video_' . $video_id); ?>" 
                                   onclick="return confirm('Are you sure you want to delete this video?');" 
                                   class="button button-small" style="color: #dc3232;">Delete</a>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                <?php else : ?>
                    <tr>
                        <td colspan="8">No videos found.</td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
        
        <p style="margin-top: 20px;">
            <strong>Total Videos:</strong> <?php echo $query->found_posts; ?>
        </p>
    </div>
    <?php
    wp_reset_postdata();
}

/* =========================================
 * ALL VIDEOS ADMIN PAGE (Legacy)
 * ========================================= */
function bvt_all_videos_page() {
    global $wpdb;
    
    // Handle delete action
    if (isset($_GET['action']) && $_GET['action'] == 'delete' && isset($_GET['video_id'])) {
        if (!current_user_can('manage_options')) {
            wp_die('Unauthorized');
        }
        check_admin_referer('delete_video_' . intval($_GET['video_id']));
        wp_delete_post(intval($_GET['video_id']), true);
        echo '<div class="notice notice-success is-dismissible"><p>Video deleted successfully!</p></div>';
    }
    
    $query = new WP_Query([
        'post_type' => 'video_link',
        'posts_per_page' => -1,
        'orderby' => 'date',
        'order' => 'DESC',
    ]);
    
    $table = $wpdb->prefix . 'video_clicks';
    $coins_table = $wpdb->prefix . 'user_claim_coins';
    
    ?>
    <div class="wrap">
        <h1>All Videos</h1>
        <table class="wp-list-table widefat fixed striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Video URL</th>
                    <th>Date Added</th>
                    <th>Total Clicks</th>
                    <th>Coins Claimed</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php if ($query->have_posts()) : ?>
                    <?php while ($query->have_posts()) : $query->the_post(); 
                        $video_id = get_the_ID();
                        $video_url = get_post_meta($video_id, '_video_url', true);
                        $click_count = $wpdb->get_var($wpdb->prepare(
                            "SELECT COUNT(*) FROM $table WHERE video_id = %d",
                            $video_id
                        ));
                        
                        // Get coins claimed count for this video
                        $coins_claimed_count = $wpdb->get_var($wpdb->prepare(
                            "SELECT COUNT(*) 
                             FROM $coins_table ucc
                             INNER JOIN $table vc ON ucc.click_id = vc.id
                             WHERE vc.video_id = %d 
                             AND ucc.transaction_type = 'claim'",
                            $video_id
                        ));
                    ?>
                        <tr>
                            <td><?php echo $video_id; ?></td>
                            <td><a href="<?php echo esc_url($video_url); ?>" target="_blank"><?php echo esc_html($video_url); ?></a></td>
                            <td><?php echo get_the_date(); ?></td>
                            <td><?php echo intval($click_count); ?></td>
                            <td><strong style="color: #ff6b00;"><?php echo intval($coins_claimed_count); ?></strong></td>
                            <td>
                                <a href="<?php echo wp_nonce_url(admin_url('admin.php?page=bvt-all-videos&action=delete&video_id=' . $video_id), 'delete_video_' . $video_id); ?>" 
                                   onclick="return confirm('Are you sure you want to delete this video?');" 
                                   class="button button-small">Delete</a>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                <?php else : ?>
                    <tr>
                        <td colspan="6">No videos found.</td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
    <?php
    wp_reset_postdata();
}

/* =========================================
 * TRACKING STATS ADMIN PAGE
 * ========================================= */
function bvt_tracking_stats_page() {
    global $wpdb;
    $table = $wpdb->prefix . 'video_clicks';
    
    // Get statistics
    $total_clicks = $wpdb->get_var("SELECT COUNT(*) FROM $table");
    $total_returns = $wpdb->get_var("SELECT COUNT(*) FROM $table WHERE return_time IS NOT NULL");
    $pending_returns = $wpdb->get_var("SELECT COUNT(*) FROM $table WHERE return_time IS NULL");
    
    // Get recent clicks
    $recent_clicks = $wpdb->get_results(
        "SELECT c.*, p.post_title as video_url 
         FROM $table c 
         LEFT JOIN {$wpdb->posts} p ON c.video_id = p.ID 
         ORDER BY c.redirect_time DESC 
         LIMIT 50"
    );
    
    ?>
    <div class="wrap">
        <h1>Tracking Statistics</h1>
        
        <div class="card" style="max-width: 800px; margin: 20px 0;">
            <h2>Overview</h2>
            <table class="form-table">
                <tr>
                    <th>Total Clicks:</th>
                    <td><strong><?php echo intval($total_clicks); ?></strong></td>
                </tr>
                <tr>
                    <th>Total Returns:</th>
                    <td><strong><?php echo intval($total_returns); ?></strong></td>
                </tr>
                <tr>
                    <th>Pending Returns:</th>
                    <td><strong><?php echo intval($pending_returns); ?></strong></td>
                </tr>
                <tr>
                    <th>Return Rate:</th>
                    <td><strong><?php echo $total_clicks > 0 ? number_format(($total_returns / $total_clicks) * 100, 2) : 0; ?>%</strong></td>
                </tr>
            </table>
        </div>
        
        <h2>Recent Clicks</h2>
        <table class="wp-list-table widefat fixed striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>User ID</th>
                    <th>Video URL</th>
                    <th>Redirect Time</th>
                    <th>Return Time</th>
                    <th>IP Address</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <?php if ($recent_clicks) : ?>
                    <?php foreach ($recent_clicks as $click) : ?>
                        <tr>
                            <td><?php echo $click->id; ?></td>
                            <td><?php echo $click->user_id ? $click->user_id : 'Guest'; ?></td>
                            <td><?php echo esc_html($click->video_url); ?></td>
                            <td><?php echo $click->redirect_time ? date('Y-m-d H:i:s', strtotime($click->redirect_time)) : '-'; ?></td>
                            <td><?php echo $click->return_time ? date('Y-m-d H:i:s', strtotime($click->return_time)) : '<span style="color:red;">Pending</span>'; ?></td>
                            <td><?php echo esc_html($click->ip_address); ?></td>
                            <td><?php echo $click->return_time ? '<span style="color:green;">Returned</span>' : '<span style="color:orange;">Not Returned</span>'; ?></td>
                        </tr>
                    <?php endforeach; ?>
                <?php else : ?>
                    <tr>
                        <td colspan="7">No tracking data found.</td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
    <?php
}

/* =========================================
 * SHORTCODES ADMIN PAGE
 * ========================================= */
function bvt_shortcodes_page() {
    ?>
    <div class="wrap">
        <h1>Available Shortcodes</h1>
        <p>Use these shortcodes in your posts, pages, or widgets to display video functionality.</p>
        
        <div style="margin-top: 30px;">
            
            <!-- Shortcode 1: video_links -->
            <div class="card" style="max-width: 1000px; margin-bottom: 30px; padding: 20px;">
                <h2 style="margin-top: 0; color: #2271b1;">[video_links]</h2>
                <p><strong>Description:</strong> Displays all video links with thumbnails and play buttons. Users can click to watch videos and earn coins.</p>
                
                <h3>Features:</h3>
                <ul>
                    <li>Shows all published videos (admin and user-uploaded)</li>
                    <li>User-uploaded videos appear first, then admin videos</li>
                    <li>Automatic YouTube thumbnail extraction</li>
                    <li>Play button overlay on thumbnails</li>
                    <li>Tracks clicks and redirects for coin rewards</li>
                    <li>Hides videos that user claimed coins from (12-hour cooldown)</li>
                    <li>Shows "Claim Coins" button for eligible users (24-hour window)</li>
                    <li>Displays user's coin balance</li>
                </ul>
                
                <h3>Usage:</h3>
                <div style="background: #f0f0f0; padding: 15px; border-radius: 3px; margin: 10px 0;">
                    <code style="font-size: 16px; color: #d63384;">[video_links]</code>
                </div>
                
                <h3>Example:</h3>
                <div style="background: #f0f0f0; padding: 15px; border-radius: 3px; margin: 10px 0;">
                    <p>Add this shortcode to any page or post:</p>
                    <pre style="background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 3px;">[video_links]</pre>
                </div>
                
                <h3>Where to Use:</h3>
                <ul>
                    <li>In page/post content: <code>[video_links]</code></li>
                    <li>In widgets: Add shortcode widget and paste <code>[video_links]</code></li>
                    <li>In theme templates: <code>&lt;?php echo do_shortcode('[video_links]'); ?&gt;</code></li>
                </ul>
                
                <h3>User Experience:</h3>
                <ul>
                    <li><strong>Logged-in users:</strong> Can see videos, click to watch, and claim coins</li>
                    <li><strong>Guests:</strong> Can see videos and click to watch (no coin tracking)</li>
                    <li><strong>Coin display:</strong> Shows total coins and claim button if eligible</li>
                </ul>
            </div>
            
            <!-- Shortcode 2: upload_video -->
            <div class="card" style="max-width: 1000px; margin-bottom: 30px; padding: 20px;">
                <h2 style="margin-top: 0; color: #2271b1;">[upload_video]</h2>
                <p><strong>Description:</strong> Allows logged-in users to upload video URLs. Requires 10 coins per upload.</p>
                
                <h3>Features:</h3>
                <ul>
                    <li>Upload form for video URLs (YouTube, Facebook, Instagram)</li>
                    <li>Coin balance display</li>
                    <li>Automatic coin deduction (10 coins per video)</li>
                    <li>URL validation</li>
                    <li>Success/error messages</li>
                    <li>Only visible to logged-in users with 10+ coins</li>
                </ul>
                
                <h3>Requirements:</h3>
                <ul>
                    <li>User must be logged in</li>
                    <li>User must have at least <strong>10 coins</strong></li>
                    <li>Valid video URL (YouTube, Facebook, or Instagram)</li>
                </ul>
                
                <h3>Usage:</h3>
                <div style="background: #f0f0f0; padding: 15px; border-radius: 3px; margin: 10px 0;">
                    <code style="font-size: 16px; color: #d63384;">[upload_video]</code>
                </div>
                
                <h3>Example:</h3>
                <div style="background: #f0f0f0; padding: 15px; border-radius: 3px; margin: 10px 0;">
                    <p>Add this shortcode to any page or post:</p>
                    <pre style="background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 3px;">[upload_video]</pre>
                </div>
                
                <h3>Where to Use:</h3>
                <ul>
                    <li>In page/post content: <code>[upload_video]</code></li>
                    <li>In widgets: Add shortcode widget and paste <code>[upload_video]</code></li>
                    <li>In theme templates: <code>&lt;?php echo do_shortcode('[upload_video]'); ?&gt;</code></li>
                </ul>
                
                <h3>User Experience:</h3>
                <ul>
                    <li><strong>Not logged in:</strong> Shows login prompt</li>
                    <li><strong>Logged in with &lt; 10 coins:</strong> Shows message "You need at least 10 coins"</li>
                    <li><strong>Logged in with 10+ coins:</strong> Shows upload form</li>
                    <li><strong>After upload:</strong> 10 coins deducted, success message shown</li>
                </ul>
                
                <h3>Coin System:</h3>
                <ul>
                    <li>Cost: <strong>10 coins</strong> per video upload</li>
                    <li>Coins are deducted immediately upon successful upload</li>
                    <li>If deduction fails, video is not created (transaction rollback)</li>
                </ul>
            </div>
            
            <!-- Combined Usage Example -->
            <div class="card" style="max-width: 1000px; margin-bottom: 30px; padding: 20px; background: #e7f3ff; border: 2px solid #2271b1;">
                <h2 style="margin-top: 0; color: #2271b1;">ðŸ“‹ Complete Setup Example</h2>
                <p><strong>Recommended page structure:</strong></p>
                
                <h3>Page 1: Video Gallery</h3>
                <div style="background: #fff; padding: 15px; border-radius: 3px; margin: 10px 0;">
                    <p><strong>Title:</strong> Watch Videos & Earn Coins</p>
                    <p><strong>Content:</strong></p>
                    <pre style="background: #f0f0f0; padding: 10px; border: 1px solid #ddd; border-radius: 3px;">[video_links]</pre>
                    <p>This page shows all videos. Users can watch and claim coins.</p>
                </div>
                
                <h3>Page 2: Upload Video</h3>
                <div style="background: #fff; padding: 15px; border-radius: 3px; margin: 10px 0;">
                    <p><strong>Title:</strong> Upload Your Video</p>
                    <p><strong>Content:</strong></p>
                    <pre style="background: #f0f0f0; padding: 10px; border: 1px solid #ddd; border-radius: 3px;">[upload_video]</pre>
                    <p>This page allows users to upload videos (requires 10 coins).</p>
                </div>
                
                <h3>Combined Page (All-in-One)</h3>
                <div style="background: #fff; padding: 15px; border-radius: 3px; margin: 10px 0;">
                    <p><strong>Title:</strong> Video Center</p>
                    <p><strong>Content:</strong></p>
                    <pre style="background: #f0f0f0; padding: 10px; border: 1px solid #ddd; border-radius: 3px;">&lt;h2&gt;Upload Video&lt;/h2&gt;
[upload_video]

&lt;h2&gt;Watch Videos &amp; Earn Coins&lt;/h2&gt;
[video_links]</pre>
                    <p>This combines both shortcodes on one page.</p>
                </div>
            </div>
            
            <!-- Quick Reference -->
            <div class="card" style="max-width: 1000px; margin-bottom: 30px; padding: 20px; background: #fff3cd; border: 2px solid #ffc107;">
                <h2 style="margin-top: 0; color: #856404;">âš¡ Quick Reference</h2>
                <table class="widefat" style="margin-top: 15px;">
                    <thead>
                        <tr>
                            <th>Shortcode</th>
                            <th>Purpose</th>
                            <th>Requirements</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>[video_links]</code></td>
                            <td>Display all videos with thumbnails</td>
                            <td>None (works for all users)</td>
                        </tr>
                        <tr>
                            <td><code>[upload_video]</code></td>
                            <td>Allow users to upload videos</td>
                            <td>Logged in + 10 coins</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Tips -->
            <div class="card" style="max-width: 1000px; margin-bottom: 30px; padding: 20px;">
                <h2 style="margin-top: 0; color: #2271b1;">ðŸ’¡ Tips & Best Practices</h2>
                <ul>
                    <li><strong>Video Display Order:</strong> User-uploaded videos appear first, then admin videos</li>
                    <li><strong>Hidden Videos:</strong> Videos hidden by admin won't appear in <code>[video_links]</code></li>
                    <li><strong>Coin System:</strong> Users earn 1 coin per video watched (if they return after 2+ minutes)</li>
                    <li><strong>Upload Cost:</strong> Each video upload costs 10 coins</li>
                    <li><strong>Cooldown:</strong> Videos are hidden for 12 hours after user claims coins</li>
                    <li><strong>Claim Window:</strong> Users have 24 hours to claim coins after watching</li>
                    <li><strong>Multiple Shortcodes:</strong> You can use both shortcodes on the same page</li>
                    <li><strong>Widget Support:</strong> Both shortcodes work in WordPress widgets</li>
                </ul>
            </div>
            
        </div>
    </div>
    <?php
}

/* =========================================
 * HANDLE BULK UPLOAD
 * ========================================= */
add_action('admin_init', function () {
    if (!isset($_POST['bvt_submit'])) return;
    if (!current_user_can('manage_options')) return;
    if (!wp_verify_nonce($_POST['_wpnonce'], 'bvt_upload_nonce')) {
        wp_redirect(admin_url('admin.php?page=bulk-video-upload&error=' . urlencode('Security check failed')));
        exit;
    }

    $urls = explode("\n", sanitize_textarea_field($_POST['video_urls']));
    $count = 0;
    $errors = [];
    
    foreach ($urls as $url) {
        $url = trim($url);
        if (empty($url)) continue;
        
        // Validate URL
        if (!filter_var($url, FILTER_VALIDATE_URL)) {
            $errors[] = "Invalid URL: " . esc_html($url);
            continue;
        }

        $result = wp_insert_post([
            'post_type'   => 'video_link',
            'post_title'  => $url,
            'post_status' => 'publish',
            'meta_input'  => [
                '_video_url' => esc_url_raw($url),
            ],
        ]);
        
        if (is_wp_error($result)) {
            $errors[] = "Failed to add: " . esc_html($url);
        } else {
            $count++;
        }
    }

    if ($count > 0) {
        $message = "Successfully uploaded {$count} video(s).";
        if (!empty($errors)) {
            $message .= " " . count($errors) . " error(s) occurred.";
        }
        wp_redirect(admin_url('admin.php?page=bulk-video-upload&success=1&count=' . $count));
    } else {
        $error_msg = !empty($errors) ? implode(', ', $errors) : 'No valid URLs found';
        wp_redirect(admin_url('admin.php?page=bulk-video-upload&error=' . urlencode($error_msg)));
    }
    exit;
});

/* =========================================
 * FRONTEND SHORTCODE
 * ========================================= */
add_shortcode('video_links', function () {
    global $wpdb;
    $user_id = is_user_logged_in() ? get_current_user_id() : 0;
    
    // Get video IDs that should be hidden (claimed within last 12 hours by this user)
    $hidden_video_ids = [];
    if ($user_id > 0) {
        $coins_table = $wpdb->prefix . 'user_claim_coins';
        $table = $wpdb->prefix . 'video_clicks';
        // Get videos where user claimed coins within last 12 hours
        $hidden_videos = $wpdb->get_col($wpdb->prepare(
            "SELECT DISTINCT c.video_id 
             FROM $table c
             INNER JOIN $coins_table ucc ON c.id = ucc.click_id
             WHERE ucc.user_id = %d 
             AND ucc.claimed_at >= DATE_SUB(NOW(), INTERVAL 12 HOUR)
             AND c.video_id IS NOT NULL",
            $user_id
        ));
        $hidden_video_ids = $hidden_videos ? array_map('intval', $hidden_videos) : [];
    }
    
    // Get all videos (user-uploaded and admin-uploaded)
    // First, get user-uploaded videos (priority)
    $user_videos_args = [
        'post_type' => 'video_link',
        'posts_per_page' => -1,
        'meta_query' => [
            [
                'key' => '_uploaded_by',
                'compare' => 'EXISTS'
            ],
            [
                'key' => '_video_hidden',
                'compare' => 'NOT EXISTS'
            ]
        ],
        'orderby' => 'date',
        'order' => 'DESC'
    ];
    
    // Exclude hidden videos if user is logged in
    if (!empty($hidden_video_ids)) {
        $user_videos_args['post__not_in'] = $hidden_video_ids;
    }
    
    $user_videos_query = new WP_Query($user_videos_args);
    
    // Get admin-uploaded videos
    $admin_videos_args = [
        'post_type' => 'video_link',
        'posts_per_page' => -1,
        'meta_query' => [
            [
                'key' => '_uploaded_by',
                'compare' => 'NOT EXISTS'
            ],
            [
                'key' => '_video_hidden',
                'compare' => 'NOT EXISTS'
            ]
        ],
        'orderby' => 'date',
        'order' => 'DESC'
    ];
    
    // Exclude hidden videos if user is logged in
    if (!empty($hidden_video_ids)) {
        $admin_videos_args['post__not_in'] = $hidden_video_ids;
    }
    
    $admin_videos_query = new WP_Query($admin_videos_args);

    ob_start();

    echo '<div class="video-links">';
    
    // Display user-uploaded videos first (priority)
    if ($user_videos_query->have_posts()) {
        while ($user_videos_query->have_posts()) {
            $user_videos_query->the_post();
            $video_id = get_the_ID();
            $url = get_post_meta($video_id, '_video_url', true);
            $thumbnail = bvt_get_video_thumbnail($url, $video_id);
            
            echo '<div class="video-item" style="display:inline-block; margin:10px; text-align:center;">
                    <div class="video-card" data-url="'.esc_url($url).'" data-id="'.$video_id.'" style="position:relative; cursor:pointer; display:inline-block;">
                        <img src="'.$thumbnail.'" style="width:320px; height:180px; object-fit:cover;">
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:50px; color:#fff; pointer-events:none;">â–¶</div>
                    </div>
                  </div>';
        }
        wp_reset_postdata();
    }
    
    // Display admin-uploaded videos (after user videos)
    if ($admin_videos_query->have_posts()) {
        while ($admin_videos_query->have_posts()) {
            $admin_videos_query->the_post();
            $video_id = get_the_ID();
            $url = get_post_meta($video_id, '_video_url', true);
            $thumbnail = bvt_get_video_thumbnail($url, $video_id);
            
            echo '<div class="video-item" style="display:inline-block; margin:10px; text-align:center;">
                    <div class="video-card" data-url="'.esc_url($url).'" data-id="'.$video_id.'" style="position:relative; cursor:pointer; display:inline-block;">
                        <img src="'.$thumbnail.'" style="width:320px; height:180px; object-fit:cover;">
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:50px; color:#fff; pointer-events:none;">â–¶</div>
                    </div>
                  </div>';
        }
        wp_reset_postdata();
    }

    echo '</div>';
    
    // Show Claim Coins button for logged-in users with eligible coins (within 24 hours)
    if (is_user_logged_in()) {
        $user_id = get_current_user_id();
        $table = $wpdb->prefix . 'video_clicks';
        
        // Get eligible but not claimed clicks for this user that are within 24 hours
        $eligible_clicks = $wpdb->get_results($wpdb->prepare(
            "SELECT id, video_id, video_url, redirect_time, return_time, coins_eligible_at 
             FROM $table 
             WHERE user_id = %d 
             AND coins_eligible = 1 
             AND coins_claimed = 0 
             AND coins_eligible_at IS NOT NULL
             AND coins_eligible_at >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
             ORDER BY id DESC",
            $user_id
        ));
        
        // Get total claimed coins
        $total_coins = bvt_get_user_coins($user_id);
        
        if ($eligible_clicks || $total_coins > 0) {
            echo '<div style="margin-top: 30px; padding: 20px; background: #f0f0f0; border-radius: 5px; text-align: center;">';
            echo '<h3 style="margin-top: 0;">Your Coins: <span style="color: #ff6b00; font-size: 24px;">' . $total_coins . '</span></h3>';
            
            if ($eligible_clicks) {
                $eligible_count = count($eligible_clicks);
                // Calculate time remaining for oldest eligible click
                $oldest_click = $eligible_clicks[0];
                if ($oldest_click->coins_eligible_at) {
                    $eligible_time = strtotime($oldest_click->coins_eligible_at);
                    $expiry_time = $eligible_time + (24 * 60 * 60); // 24 hours
                    $time_remaining = $expiry_time - time();
                    $hours_remaining = floor($time_remaining / 3600);
                    $minutes_remaining = floor(($time_remaining % 3600) / 60);
                    
                    if ($time_remaining > 0) {
                        echo '<p>You have <strong>' . $eligible_count . '</strong> video(s) eligible for coins!</p>';
                        echo '<p style="font-size: 12px; color: #666;">Time remaining to claim: <strong>' . $hours_remaining . 'h ' . $minutes_remaining . 'm</strong></p>';
                        echo '<button id="bvt-claim-coins-btn" class="button button-primary" style="font-size: 16px; padding: 10px 20px;">Claim Coins</button>';
                        echo '<div id="bvt-claim-message" style="margin-top: 10px;"></div>';
                    }
                } else {
                    echo '<p>You have <strong>' . $eligible_count . '</strong> video(s) eligible for coins!</p>';
                    echo '<button id="bvt-claim-coins-btn" class="button button-primary" style="font-size: 16px; padding: 10px 20px;">Claim Coins</button>';
                    echo '<div id="bvt-claim-message" style="margin-top: 10px;"></div>';
                }
            }
            
            echo '</div>';
        }
    }

    // Add JS to handle click & tracking
    $is_logged_in = is_user_logged_in();
    $login_url = wp_login_url(get_permalink());
    ?>

<script>
const isUserLoggedIn = <?php echo $is_logged_in ? 'true' : 'false'; ?>;
const loginUrl = '<?php echo esc_js($login_url); ?>';
let currentReturnToken = null;

function showLoginPopup() {
    const overlay = document.createElement('div');
    overlay.id = 'bvt-login-popup-overlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:999999;display:flex;align-items:center;justify-content:center;';
    const popup = document.createElement('div');
    popup.style.cssText = 'background:white;padding:30px;border-radius:10px;max-width:400px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.3);';
    popup.innerHTML = `
        <h2 style="margin-top:0;color:#333;">Login Required</h2>
        <p style="color:#666;margin-bottom:20px;">You must be logged in to earn coins.</p>
        <div style="display:flex;gap:10px;justify-content:center;">
            <a href="${loginUrl}" class="button button-primary" style="padding:10px 20px;text-decoration:none;">Login</a>
            <button onclick="document.getElementById('bvt-login-popup-overlay').remove();" class="button">Cancel</button>
        </div>
    `;
    overlay.appendChild(popup);
    document.body.appendChild(overlay);
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
}

// Send return confirmation when user interacts
function sendReturnConfirmation() {
    if (!currentReturnToken || !isUserLoggedIn) return;

    fetch("<?php echo admin_url('admin-ajax.php'); ?>", {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'action=bvt_mark_return&token=' + encodeURIComponent(currentReturnToken)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.data.eligible) {
            alert('ðŸŽ‰ Success! You watched the video long enough.\nYou can now claim your 1 coin!');
        }
        // Remove listeners after return is recorded
        document.removeEventListener('click', sendReturnConfirmation);
        document.removeEventListener('scroll', sendReturnConfirmation);
        document.removeEventListener('mousemove', sendReturnConfirmation);
        document.removeEventListener('keydown', sendReturnConfirmation);
    })
    .catch(() => {});
}

// Activate tracking when user clicks a video
function startReturnTracking(token) {
    currentReturnToken = token;

    // Trigger on any user activity
    document.addEventListener('click', sendReturnConfirmation, { once: true });
    document.addEventListener('scroll', sendReturnConfirmation, { once: true });
    document.addEventListener('mousemove', sendReturnConfirmation, { once: true });
    document.addEventListener('keydown', sendReturnConfirmation, { once: true });

    // Fallback: trigger after 15 seconds in case user is inactive
    setTimeout(sendReturnConfirmation, 15000);
}

document.querySelectorAll('.video-card').forEach(function(card) {
    card.addEventListener('click', function(e) {
        e.preventDefault();

        if (!isUserLoggedIn) {
            showLoginPopup();
            return;
        }

        const videoId = card.dataset.id;
        const videoUrl = card.dataset.url;

        fetch("<?php echo admin_url('admin-ajax.php'); ?>?action=bvt_track_redirect", {
            method: 'POST',
            credentials: 'same-origin',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'video_id=' + encodeURIComponent(videoId)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data.token) {
                startReturnTracking(data.data.token);

                alert(
                    "Video opening in new tab...\n\n" +
                    "Watch for at least 2 minutes.\n" +
                    "When you return to this page and scroll, click, or type â€”\n" +
                    "we will automatically detect it and make you eligible for 1 coin!"
                );

                window.open(videoUrl, '_blank');
            } else {
                window.open(videoUrl, '_blank');
            }
        })
        .catch(() => {
            window.open(videoUrl, '_blank');
        });
    });
});
    
    // Handle Claim Coins button
    const claimBtn = document.getElementById('bvt-claim-coins-btn');
    if (claimBtn) {
        claimBtn.addEventListener('click', function() {
            const btn = this;
            const messageDiv = document.getElementById('bvt-claim-message');
            btn.disabled = true;
            btn.textContent = 'Claiming...';
            
            fetch("<?php echo admin_url('admin-ajax.php'); ?>?action=bvt_claim_coins", {
                method: 'POST',
                credentials: 'same-origin',
                headers: {'Content-Type':'application/x-www-form-urlencoded'},
                body: 'action=claim'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageDiv.innerHTML = '<div style="color: green; font-weight: bold;">' + data.data.message + '</div>';
                    if (data.data.new_balance !== undefined) {
                        // Update coin display
                        const coinDisplay = document.querySelector('h3 span');
                        if (coinDisplay) {
                            coinDisplay.textContent = data.data.new_balance;
                        }
                    }
                    btn.style.display = 'none';
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                } else {
                    messageDiv.innerHTML = '<div style="color: red;">' + data.data.message + '</div>';
                    btn.disabled = false;
                    btn.textContent = 'Claim Coins';
                }
            })
            .catch(error => {
                messageDiv.innerHTML = '<div style="color: red;">Error claiming coins. Please try again.</div>';
                btn.disabled = false;
                btn.textContent = 'Claim Coins';
            });
        });
    }
    </script>
    <?php

    return ob_get_clean();
});

/* =========================================
 * FRONTEND VIDEO UPLOAD SHORTCODE
 * ========================================= */
add_shortcode('upload_video', function () {
    if (!is_user_logged_in()) {
        return '<div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; text-align: center;">
                    <p>Please <a href="' . wp_login_url(get_permalink()) . '">login</a> to upload videos.</p>
                </div>';
    }
    
    $user_id = get_current_user_id();
    $user_coins = bvt_get_user_coins($user_id);
    $required_coins = 10;
    
    ob_start();
    ?>
    <div style="max-width: 600px; margin: 20px auto; padding: 20px; background: #f9f9f9; border-radius: 5px;">
        <h2 style="margin-top: 0;">Upload Video URL</h2>
        <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 3px;">
            <strong>Your Coins:</strong> <span style="color: #ff6b00; font-size: 18px;"><?php echo $user_coins; ?></span>
            <br>
            <small>Required: <?php echo $required_coins; ?> coins per video upload</small>
        </div>
        
        <?php if ($user_coins >= $required_coins && $user_coins > 0) : ?>
            <form id="bvt-upload-video-form">
                <div style="margin-bottom: 15px;">
                    <label for="video_url" style="display: block; margin-bottom: 5px; font-weight: bold;">Video URL:</label>
                    <input type="url" id="video_url" name="video_url" required 
                           placeholder="https://youtube.com/watch?v=..." 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 3px; box-sizing: border-box;">
                    <small style="color: #666;">Enter YouTube, Facebook, or Instagram video URL</small>
                </div>
                <button type="submit" class="button button-primary" style="width: 100%; padding: 12px; font-size: 16px;">
                    Upload Video (Cost: <?php echo $required_coins; ?> Coins)
                </button>
                <div id="bvt-upload-message" style="margin-top: 15px;"></div>
            </form>
        <?php else : ?>
            <div style="padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 3px; text-align: center;">
                <?php if ($user_coins == 0) : ?>
                    <p style="margin: 0; font-weight: bold; color: #856404;">You have <strong>0 coins</strong>.</p>
                    <p style="margin: 5px 0 0 0;">You need at least <strong><?php echo $required_coins; ?> coins</strong> to upload a video.</p>
                    <p style="margin: 5px 0 0 0;">Watch videos and claim coins to earn more!</p>
                <?php else : ?>
                    <p style="margin: 0;">You need at least <strong><?php echo $required_coins; ?> coins</strong> to upload a video.</p>
                    <p style="margin: 5px 0 0 0;">You currently have <strong><?php echo $user_coins; ?> coins</strong>.</p>
                    <p style="margin: 5px 0 0 0;">Watch more videos and claim coins to earn more!</p>
                <?php endif; ?>
            </div>
        <?php endif; ?>
    </div>
    
    <script>
    document.getElementById('bvt-upload-video-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        const videoUrl = document.getElementById('video_url').value;
        const messageDiv = document.getElementById('bvt-upload-message');
        const submitBtn = form.querySelector('button[type="submit"]');
        const userCoins = <?php echo $user_coins; ?>;
        const requiredCoins = <?php echo $required_coins; ?>;
        
        // Client-side validation: Check if user has enough coins
        if (userCoins < requiredCoins || userCoins <= 0) {
            messageDiv.innerHTML = '<div style="color: red; padding: 10px; background: #ffe6e6; border-radius: 3px;">You do not have enough coins to upload videos. You need ' + requiredCoins + ' coins but you have ' + userCoins + ' coins.</div>';
            return;
        }
        
        if (!videoUrl) {
            messageDiv.innerHTML = '<div style="color: red; padding: 10px; background: #ffe6e6; border-radius: 3px;">Please enter a video URL</div>';
            return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Uploading...';
        messageDiv.innerHTML = '';
        
        fetch("<?php echo admin_url('admin-ajax.php'); ?>?action=bvt_upload_video", {
            method: 'POST',
            credentials: 'same-origin',
            headers: {'Content-Type':'application/x-www-form-urlencoded'},
            body: 'video_url=' + encodeURIComponent(videoUrl)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageDiv.innerHTML = '<div style="color: green; padding: 10px; background: #e6ffe6; border-radius: 3px; font-weight: bold;">' + data.data.message + '</div>';
                form.reset();
                // Reload page after 2 seconds to update coin balance
                setTimeout(function() {
                    location.reload();
                }, 2000);
            } else {
                messageDiv.innerHTML = '<div style="color: red; padding: 10px; background: #ffe6e6; border-radius: 3px;">' + data.data.message + '</div>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Video (Cost: <?php echo $required_coins; ?> Coins)';
            }
        })
        .catch(error => {
            messageDiv.innerHTML = '<div style="color: red; padding: 10px; background: #ffe6e6; border-radius: 3px;">Error uploading video. Please try again.</div>';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Upload Video (Cost: <?php echo $required_coins; ?> Coins)';
        });
    });
    </script>
    <?php
    
    return ob_get_clean();
});

/* =========================================
 * AJAX HANDLER FOR FRONTEND VIDEO UPLOAD
 * ========================================= */
add_action('wp_ajax_bvt_upload_video', 'bvt_upload_video');
add_action('wp_ajax_nopriv_bvt_upload_video', 'bvt_upload_video');

function bvt_upload_video() {
    // Security check: Must be logged in
    if (!is_user_logged_in()) {
        wp_send_json_error(['message' => 'You must be logged in to upload videos']);
        return;
    }
    
    // Security check: Must provide video URL
    if (!isset($_POST['video_url']) || empty($_POST['video_url'])) {
        wp_send_json_error(['message' => 'Please provide a video URL']);
        return;
    }
    
    $user_id = get_current_user_id();
    $video_url = esc_url_raw($_POST['video_url']);
    $required_coins = 10;
    
    // Validate URL format
    if (!filter_var($video_url, FILTER_VALIDATE_URL)) {
        wp_send_json_error(['message' => 'Invalid URL format']);
        return;
    }
    
    // CRITICAL: Check user has enough coins (must be >= 10, not just > 0)
    $user_coins = bvt_get_user_coins($user_id);
    
    // Strict validation: User must have at least 10 coins
    if ($user_coins < $required_coins) {
        $message = "You don't have enough coins to upload videos. ";
        if ($user_coins == 0) {
            $message .= "You currently have 0 coins. ";
        } else {
            $message .= "You need {$required_coins} coins but you only have {$user_coins} coins. ";
        }
        $message .= "Watch videos and claim coins to earn more!";
        wp_send_json_error(['message' => $message]);
        return;
    }
    
    // Double-check: Ensure coins are not negative or zero
    if ($user_coins <= 0) {
        wp_send_json_error(['message' => 'You have no coins. Please watch videos and claim coins first.']);
        return;
    }
    
    // Insert video
    $result = wp_insert_post([
        'post_type'   => 'video_link',
        'post_title'  => $video_url,
        'post_status' => 'publish',
        'meta_input'  => [
            '_video_url' => $video_url,
            '_uploaded_by' => $user_id,
        ],
    ]);
    
    if (is_wp_error($result)) {
        wp_send_json_error(['message' => 'Failed to upload video. Please try again.']);
        return;
    }
    
    // Final check before deducting: Re-verify user still has enough coins (prevent race conditions)
    global $wpdb;
    $coins_table = $wpdb->prefix . 'user_claim_coins';
    $current_balance = bvt_get_user_coins($user_id);
    
    if ($current_balance < $required_coins) {
        // Rollback: delete the video if user doesn't have enough coins
        wp_delete_post($result, true);
        wp_send_json_error(['message' => "Insufficient coins. Your balance changed. You need {$required_coins} coins but you have {$current_balance}."]);
        return;
    }
    
    // Deduct coins
    $deduction_result = $wpdb->insert($coins_table, [
        'user_id' => $user_id,
        'click_id' => null,
        'coins_amount' => -$required_coins, // Negative amount for deduction
        'claimed_at' => current_time('mysql'),
        'transaction_type' => 'video_upload',
        'video_upload_id' => $result
    ], [
        '%d', '%d', '%d', '%s', '%s', '%d'
    ]);
    
    if ($deduction_result === false) {
        // Rollback: delete the video if coin deduction fails
        wp_delete_post($result, true);
        wp_send_json_error(['message' => 'Failed to process payment. Video not uploaded.']);
        return;
    }
    
    $new_balance = bvt_get_user_coins($user_id);
    
    wp_send_json_success([
        'message' => "Video uploaded successfully! {$required_coins} coins deducted. Your new balance: {$new_balance} coins.",
        'new_balance' => $new_balance,
        'video_id' => $result
    ]);
}

/* =========================================
 * AJAX HANDLER FOR REDIRECT TRACKING
 * ========================================= */
/* =========================================
 * AJAX HANDLER FOR REDIRECT TRACKING
 * ========================================= */
add_action('wp_ajax_bvt_track_redirect', 'bvt_track_redirect');
add_action('wp_ajax_nopriv_bvt_track_redirect', 'bvt_track_redirect');
function bvt_track_redirect() {
    if (!isset($_POST['video_id'])) {
        wp_send_json_error(['message' => 'Missing video ID']);
        return;
    }

    global $wpdb;
    $video_id = intval($_POST['video_id']);
    if ($video_id <= 0) {
        wp_send_json_error(['message' => 'Invalid video ID']);
        return;
    }

    $user_id = get_current_user_id();
    $video_url = get_post_meta($video_id, '_video_url', true);
    if (empty($video_url)) {
        wp_send_json_error(['message' => 'Video not found']);
        return;
    }

    // Generate unique token
    $token = wp_generate_uuid4();

    $ip = '';
    if (!empty($_SERVER['HTTP_CLIENT_IP'])) {
        $ip = $_SERVER['HTTP_CLIENT_IP'];
    } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
        $ip = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR'])[0];
    } else {
        $ip = $_SERVER['REMOTE_ADDR'] ?? '';
    }
    $ip = sanitize_text_field($ip);

    $result = $wpdb->insert($wpdb->prefix.'video_clicks', [
        'user_id' => $user_id ?: null,
        'video_id' => $video_id,
        'video_url' => $video_url,
        'redirect_time' => current_time('mysql'),
        'ip_address' => $ip,
        'return_token' => $token
    ], [
        '%d', '%d', '%s', '%s', '%s', '%s'
    ]);

    if ($result === false) {
        wp_send_json_error(['message' => 'Failed to track click']);
    } else {
        wp_send_json_success([
            'message' => 'Click tracked',
            'token' => $token  // â† Important: return only the token
        ]);
    }
}

/* =========================================
 * AJAX HANDLER FOR CLAIMING COINS
 * ========================================= */
add_action('wp_ajax_bvt_claim_coins', 'bvt_claim_coins');
add_action('wp_ajax_nopriv_bvt_claim_coins', 'bvt_claim_coins');

function bvt_claim_coins() {
    if (!is_user_logged_in()) {
        wp_send_json_error(['message' => 'You must be logged in to claim coins']);
        return;
    }
    
    $user_id = get_current_user_id();
    global $wpdb;
    $table = $wpdb->prefix . 'video_clicks';
    $coins_table = $wpdb->prefix . 'user_claim_coins';
    
    // Get all eligible but not claimed clicks for this user (within 24 hours)
    $eligible_clicks = $wpdb->get_results($wpdb->prepare(
        "SELECT id, video_id, video_url 
         FROM $table 
         WHERE user_id = %d 
         AND coins_eligible = 1 
         AND coins_claimed = 0
         AND coins_eligible_at IS NOT NULL
         AND coins_eligible_at >= DATE_SUB(NOW(), INTERVAL 24 HOUR)",
        $user_id
    ));
    
    if (empty($eligible_clicks)) {
        wp_send_json_error(['message' => 'No coins available to claim. The 24-hour claim window has expired.']);
        return;
    }
    
    $total_coins = 0;
    $claimed_count = 0;
    
    // Process each eligible click
    foreach ($eligible_clicks as $click) {
        // Default: 1 coin per video (you can customize this)
        $coins_amount = 1;
        
        // Insert into claim coins table
        $result = $wpdb->insert($coins_table, [
            'user_id' => $user_id,
            'click_id' => $click->id,
            'coins_amount' => $coins_amount,
            'claimed_at' => current_time('mysql'),
            'transaction_type' => 'claim'
        ], [
            '%d', '%d', '%d', '%s', '%s'
        ]);
        
        if ($result !== false) {
            // Mark as claimed in video_clicks table
            $wpdb->update(
                $table,
                ['coins_claimed' => 1],
                ['id' => $click->id],
                ['%d'],
                ['%d']
            );
            
            $total_coins += $coins_amount;
            $claimed_count++;
        }
    }
    
    // Get new total balance
    $new_balance = bvt_get_user_coins($user_id);
    
    wp_send_json_success([
        'message' => "Successfully claimed {$total_coins} coin(s) from {$claimed_count} video(s)!",
        'coins_claimed' => $total_coins,
        'new_balance' => $new_balance
    ]);
}


/* =========================================
 * AJAX: Mark return when user becomes active again
 * ========================================= */
add_action('wp_ajax_bvt_mark_return', 'bvt_mark_return');
add_action('wp_ajax_nopriv_bvt_mark_return', 'bvt_mark_return');

function bvt_mark_return() {
    if (!isset($_POST['token']) || empty($_POST['token'])) {
        wp_send_json_error(['message' => 'Invalid token']);
        return;
    }

    global $wpdb;
    $table = $wpdb->prefix . 'video_clicks';
    $token = sanitize_text_field($_POST['token']);

    // Find pending click with this token
    $click = $wpdb->get_row($wpdb->prepare(
        "SELECT * FROM $table WHERE return_token = %s AND return_time IS NULL LIMIT 1",
        $token
    ));

    if (!$click) {
        wp_send_json_error(['message' => 'No pending session or already returned']);
        return;
    }

    $return_time = current_time('mysql');

    // Record return
    $wpdb->update($table, ['return_time' => $return_time], ['id' => $click->id]);

    $user_id = get_current_user_id();

    // Only logged-in users can earn coins
    if ($user_id > 0 && $click->redirect_time) {
        $redirect_date = date('Y-m-d', strtotime($click->redirect_time));
        $return_date   = date('Y-m-d', strtotime($return_time));

        if ($redirect_date === $return_date) {
            $watched_minutes = (strtotime($return_time) - strtotime($click->redirect_time)) / 60;

            if ($watched_minutes > 2) {
                $wpdb->update($table, [
                    'coins_eligible' => 1,
                    'coins_eligible_at' => $return_time
                ], ['id' => $click->id]);

                wp_send_json_success([
                    'message' => 'Return confirmed! You watched more than 2 minutes.',
                    'eligible' => true,
                    'watched_minutes' => round($watched_minutes, 1)
                ]);
                return;
            }
        }
    }

    wp_send_json_success([
        'message' => 'Return recorded.',
        'eligible' => false
    ]);
}

/* =========================================
 * TRACK USER RETURN (Improved Logic)
 * ========================================= */
add_action('wp', function() {
    // Only track return if user came from external site (check referrer)
    $referrer = isset($_SERVER['HTTP_REFERER']) ? $_SERVER['HTTP_REFERER'] : '';
    $current_domain = parse_url(home_url(), PHP_URL_HOST);
    $referrer_domain = $referrer ? parse_url($referrer, PHP_URL_HOST) : '';
    
    // If referrer is from external domain or user is logged in, check for pending returns
    if ($referrer_domain && $referrer_domain !== $current_domain) {
        global $wpdb;
        $table = $wpdb->prefix.'video_clicks';
        $user_id = get_current_user_id();
        
        // For logged-in users, match by user_id
        if ($user_id > 0) {
            $record = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $table WHERE user_id=%d AND return_time IS NULL ORDER BY id DESC LIMIT 1",
                $user_id
            ));
        } else {
            // For guests, match by IP address and recent redirect (within last hour)
            $ip = '';
            if (!empty($_SERVER['HTTP_CLIENT_IP'])) {
                $ip = sanitize_text_field($_SERVER['HTTP_CLIENT_IP']);
            } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
                $ip = sanitize_text_field($_SERVER['HTTP_X_FORWARDED_FOR']);
            } else {
                $ip = isset($_SERVER['REMOTE_ADDR']) ? sanitize_text_field($_SERVER['REMOTE_ADDR']) : '';
            }
            
            if ($ip) {
                $record = $wpdb->get_row($wpdb->prepare(
                    "SELECT * FROM $table 
                     WHERE user_id IS NULL 
                     AND ip_address=%s 
                     AND return_time IS NULL 
                     AND redirect_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
                     ORDER BY id DESC LIMIT 1",
                    $ip
                ));
            } else {
                $record = null;
            }
        }
        
        if ($record) {
            $return_time = current_time('mysql');
            $wpdb->update(
                $table,
                ['return_time' => $return_time],
                ['id' => $record->id],
                ['%s'],
                ['%d']
            );
            
            // Check if user is eligible for coins (only for logged-in users)
            if ($user_id > 0 && $record->redirect_time) {
                $redirect_date = date('Y-m-d', strtotime($record->redirect_time));
                $return_date = date('Y-m-d', strtotime($return_time));
                
                // Check if same date and time difference > 2 minutes
                if ($redirect_date === $return_date) {
                    $time_diff = (strtotime($return_time) - strtotime($record->redirect_time)) / 60; // in minutes
                    
                    if ($time_diff > 2) {
                        // Mark as eligible for coins and set eligibility timestamp
                        $wpdb->update(
                            $table,
                            [
                                'coins_eligible' => 1,
                                'coins_eligible_at' => current_time('mysql')
                            ],
                            ['id' => $record->id],
                            ['%d', '%s'],
                            ['%d']
                        );
                    }
                }
            }
        }
    }
});    



/* =========================================
 * RETURN DETECTION PAGE WITH TOKEN
 * ========================================= */

// Add rewrite rule for /video-return/
add_action('init', function() {
    add_rewrite_rule('^video-return/?$', 'index.php?bvt_return=1', 'top');
});

// Register query var
add_filter('query_vars', function($vars) {
    $vars[] = 'bvt_return';
    return $vars;
});

// Handle the return page
add_action('template_redirect', function() {
    if (get_query_var('bvt_return')) {
        global $wpdb;
        $table = $wpdb->prefix . 'video_clicks';

        $token = sanitize_text_field($_GET['token'] ?? '');

        if (empty($token)) {
            wp_die('Invalid or missing return token.', 'Error', ['response' => 400]);
        }

        // Find pending click with this token
        $click = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table WHERE return_token = %s AND return_time IS NULL LIMIT 1",
            $token
        ));

        if (!$click) {
            wp_die('This return link is invalid or has already been used.', 'Invalid Link', ['response' => 410]);
        }

        $return_time = current_time('mysql');

        // Record return time
        $wpdb->update(
            $table,
            ['return_time' => $return_time],
            ['id' => $click->id]
        );

        $user_id = get_current_user_id();

        // Only award coins if logged in, same date, and watched >2 minutes
        if ($user_id > 0 && $click->redirect_time) {
            $redirect_date = date('Y-m-d', strtotime($click->redirect_time));
            $return_date   = date('Y-m-d', strtotime($return_time));

            if ($redirect_date === $return_date) {
                $time_diff_minutes = (strtotime($return_time) - strtotime($click->redirect_time)) / 60;

                if ($time_diff_minutes > 2) {
                    $wpdb->update($table, [
                        'coins_eligible' => 1,
                        'coins_eligible_at' => $return_time
                    ], ['id' => $click->id]);
                }
            }
        }

        // Nice success message
        wp_die(
            '<div style="font-family: Arial, sans-serif; text-align: center; padding: 50px; max-width: 600px; margin: 0 auto;">
                <h1 style="color: #2271b1;">ðŸŽ‰ Thank You for Watching!</h1>
                <p style="font-size: 18px;">You have successfully returned after watching the video.</p>
                ' . ($user_id > 0
                    ? '<p style="color: green; font-weight: bold;">You are now eligible to claim 1 coin (if watched more than 2 minutes).</p>'
                    : '<p>Please <a href="' . wp_login_url() . '">log in</a> to earn coins next time.</p>'
                ) . '
                <hr style="margin: 30px 0;">
                <a href="' . home_url() . '" style="background: #2271b1; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; font-size: 16px;">â† Back to Video Gallery</a>
            </div>',
            'Video Watched Successfully',
            ['response' => 200]
        );
    }
});




