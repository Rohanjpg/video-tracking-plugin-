<?php
// Enqueue jQuery for click handling
function enqueue_custom_scripts() {
    wp_enqueue_script('jquery');
    ?>
    <script>
    jQuery(document).ready(function($) {
        $('#clean').on('click', function(e) {
            e.preventDefault();

            // Send AJAX request to logout and get auto-login token
            $.post('<?php echo admin_url("admin-ajax.php"); ?>', {
                action: 'custom_logout_login'
            }, function(response) {
                if(response.url) {
                    // Redirect to the auto-login URL
                    window.location.href = response.url;
                }
            }, 'json');
        });
    });
    </script>
    <?php
}
add_action('wp_footer', 'enqueue_custom_scripts');

// Handle logout and generate temporary login token
function custom_logout_login() {
    if (is_user_logged_in()) {
        $user_id = get_current_user_id();
        wp_logout(); // log out current user

        // Generate a one-time login token
        $token = wp_generate_password(20, false); // random token
        set_transient('auto_login_' . $token, $user_id, 60); // valid for 1 minute

        // Generate URL for automatic login
        $url = add_query_arg('auto_login_token', $token, home_url());
        wp_send_json(['url' => $url]);
    } else {
        wp_send_json(['url' => home_url()]);
    }

    wp_die();
}
add_action('wp_ajax_custom_logout_login', 'custom_logout_login');
add_action('wp_ajax_nopriv_custom_logout_login', 'custom_logout_login');

// Handle automatic login via token
function handle_auto_login_token() {
    if (isset($_GET['auto_login_token'])) {
        $token = sanitize_text_field($_GET['auto_login_token']);
        $user_id = get_transient('auto_login_' . $token);

        if ($user_id) {
            // Log the user in
            wp_set_current_user($user_id);
            wp_set_auth_cookie($user_id);
            delete_transient('auto_login_' . $token); // token can only be used once
            wp_redirect(remove_query_arg('auto_login_token'));
            exit;
        }
    }
}
add_action('init', 'handle_auto_login_token');
